from collections import namedtuple
from dataclasses import dataclass
from enum import Enum
from typing import Optional

## 모의 환경설정
# 모의 상태 맵핑
STATUS = {
    "None": 0x00,
    "StartInit": 0x01,
    "InitCompleted": 0x02,
    "StartSim": 0x03,
    "StopSim": 0x04,
    "ExitSim": 0x05,
    "Error": 0xFF,
}
STATUS_TRANSITION_DICT = {(STATUS["InitCompleted"], 1): STATUS["StartSim"], (STATUS["StartSim"], 2): STATUS["ExitSim"]}
# 모의 메시지 : 메시지 ID - 메시지 내용 맵핑
MSG_NAME_TO_MSG_ID = {"SimInitCmd": "0x01ff01", "SimCtrlCmd": "0x01ff02", "SimObjInfo": "0x026501"}
# 모의 통제 메시지 : 필드 - 상태 맵핑
MSG_TO_STATUS = {0x01: STATUS["StartSim"], 0x02: STATUS["StopSim"], 0x03: STATUS["ExitSim"]}

## 임무계획
# 감시패턴 생성 여부
GEN_SURV_PATH: bool = True
# 임무계획 알고리즘
ALGO_TO_NAME_DICT = {"Replan": "ADD", "Surv": "ADD", "Reconn": "LIG", "Attack": "ADD"}
# 비행체별 자동임무 모드 테이블
MISSION_MODE_TO_NAME_DICT = {0: "이동", 1: "감시", 2: "정찰", 3: "추적", 4: "타격"}
# 알고리즘 환경설정
# 감시 선별 알고리즘
NUM_ROWS: int = 200
NUM_COLS: int = 200
# 정찰 선별 그룹 수
MAX_GROUPS_OF_5: int = None
# 이동 표적에 대한 부분 재계획 거리 기준
TRG_POS_CHANGE_THRESHOLD = 100
# 임무계획 결과 전송 인터벌 [ms]
MP_RESULT_SEND_INTERVAL = 0.1
# 임무계획 입력 확인 여부
SHOW_INPUTS: bool = False
# 임무계획 출력 확인 여부
SHOW_OUTPUT: bool = False
# 오프라인 강화학습 데이터 확인 여부
SHOW_OFFLINE: bool = False
# GCS 표적정보 활용 여부
USE_MP_TRG: bool = False
# 이전 임무계획 출력 활용 여부
USE_PREV_MP_OUTPUT: bool = False
# 임무계획 입력 모의
STATE_PATH = ""
# 메시지 번호에 따른 임무계획 입력 업데이트 함수 정의
MSG_TO_UPDATER_DICT = {
    0x7B03: "update_replan_request",
    0x7B04: "update_mission_plan_cmd",
    0x7B05: "update_boundary",
    0x7B06: "update_avs_info",
    0x7B07: "update_mission_plan_target",
    0x7B0A: "update_circular_area",
    0x7B0B: "update_polygon_area",
    0x7B0C: "update_mission_initial_info",
    0x7B0D: "update_mission_state",
    0x7A01: "update_target_fusion_result",
    0x7C05: "update_grid_coverage_data",
}
# 메시지 주소
ADDR_GZB = {"Preproc": ("172.18.0.2", 8000), "Planner": ("10.100.80.112", 8001), "Minimap": ("172.18.0.2", 8002)}
# 메시지 헤더 포맷 정의 (ESICD v1.5)
SYS_HEADER_FMT = "> BHH"
# 메시지 전송 주기
CBIT_INTERVAL: int = 1
# ESICD v1.5 기준 메시지 정의
PAYLOAD_TO_FMT_DICT = {
    "replan_request": "> H H",
    "mission_plan_cmd": "> H H",
    "boundary": "> ii ii ii ii",
    "avs_info": "> H HH HH HHH iiH hhH I HH BHB",
    "mission_plan_target": "> H ii",
    "sw_version_req": "> B",
    "circular_area": "> iiH",
    "polygon_area": {"corner_count": "> H", "vertex": "ii"},
    "mission_initial_info": "> HH H h B B 100s HB B B",
    "mission_state": "> H",
    "mission_plan_result_ack": "> B",
    "target_fusion_result": {
        "global_target_count": "> B",
        "timestamp": "> Q",
        "is_simulation": "> B",
        "global_target_info": "> H iiH B",
        "local_target_count": "> B",
        "local_target_info": "> H H iiH",
    },
    "surv_selection_result:": "> H H H H H iiH",
    "reconn_selection_result:": "> H HH H ii HH iiH H",
    "attack_selection_result:": "> H HH H ii HH iiH H HH",
    "missoin_plan_result_info": "> H H H",
    "smp_status": "> B",
    "sw_version_res": "> H BB",
    "grid_coverage_data": ">" + f"{round(NUM_ROWS * NUM_COLS / 8)}B",
}
SIM_HEADER_FMT = "> B H B BBB Q"
MSG_TO_ID_DICT = {
    "replan_request": 0x7B03,
    "mission_plan_cmd": 0x7B04,
    "boundary": 0x7B05,
    "avs_info": 0x7B06,
    "mission_plan_target": 0x7B07,
    "sw_version_req": 0x7B09,
    "circular_area": 0x7B0A,
    "polygon_area": 0x7B0B,
    "mission_initial_info": 0x7B0C,
    "mission_state": 0x7B0D,
    "mission_plan_result_ack": 0x7B0E,
    "target_fusion_result": 0x7A01,
    "surv_selection_result": 0x7A02,
    "reconn_selection_result": 0x7A05,
    "attack_selection_result": 0x7A06,
    "missoin_plan_result_info": 0x7A07,
    "smp_status": 0x7C03,  # To 융합모듈
    "sw_version_res": 0x7C04,  # To 융합모듈
    "grid_coverage_data": 0x7C05,  # From 융합모듈
}
# 임무 재계획 판단 주기
REPLAN_INTERVAL = 10.0
TRAIN_INTERVAL = 0.5
# 임무유형 설정
MISSION_LIST = ["Attack", "Reconn", "Surv"]
# MISSION_LIST = ["Reconn", "Surv"]
# MISSION_LIST = ["Surv"]
# GUI MSG 번호 맵핑
SYS_TO_GUI_MSG_NO = {0x7B05: 0, 0x7B06: 1, 0x7A01: 2}
# ESICD v1.5 기준 해상도
Res = namedtuple(
    typename="Resolution",
    field_names=[
        "port",
        "speed",
        "lat",
        "lon",
        "alt",
        "init_alt",
        "roll",
        "pitch",
        "heading",
        "gimbal",
        "corner",
        "fov_vert",
        "fov_horz",
        "vel_n",
        "vel_e",
        "vel_d",
        "slant",
        "voltage",
    ],
)
RES = Res(
    port=10000,
    speed=0.1,
    lat=4.190951587721217e-08,
    lon=8.381903175442434e-08,
    alt=0.30365453574425877,
    init_alt=0.1,
    roll=0.0015259254737998596,
    pitch=0.0006103701895199438,
    heading=0.005493331705679495,
    gimbal=8.381903175442434e-08,
    corner=2.2888882106997894e-06,
    fov_vert=0.002746623941405356,
    fov_horz=0.002746623941405356,
    vel_n=0.009994811853389081,
    vel_e=0.009994811853389081,
    vel_d=0.005493331705679495,
    slant=0.011641532185403987,
    voltage=0.01,
)
# CRC-16 (CCITT) 테이블
CRC_16_TABLE = [
    0x0000,
    0x1021,
    0x2042,
    0x3063,
    0x4084,
    0x50A5,
    0x60C6,
    0x70E7,
    0x8108,
    0x9129,
    0xA14A,
    0xB16B,
    0xC18C,
    0xD1AD,
    0xE1CE,
    0xF1EF,
    0x1231,
    0x0210,
    0x3273,
    0x2252,
    0x52B5,
    0x4294,
    0x72F7,
    0x62D6,
    0x9339,
    0x8318,
    0xB37B,
    0xA35A,
    0xD3BD,
    0xC39C,
    0xF3FF,
    0xE3DE,
    0x2462,
    0x3443,
    0x0420,
    0x1401,
    0x64E6,
    0x74C7,
    0x44A4,
    0x5485,
    0xA56A,
    0xB54B,
    0x8528,
    0x9509,
    0xE5EE,
    0xF5CF,
    0xC5AC,
    0xD58D,
    0x3653,
    0x2672,
    0x1611,
    0x0630,
    0x76D7,
    0x66F6,
    0x5695,
    0x46B4,
    0xB75B,
    0xA77A,
    0x9719,
    0x8738,
    0xF7DF,
    0xE7FE,
    0xD79D,
    0xC7BC,
    0x48C4,
    0x58E5,
    0x6886,
    0x78A7,
    0x0840,
    0x1861,
    0x2802,
    0x3823,
    0xC9CC,
    0xD9ED,
    0xE98E,
    0xF9AF,
    0x8948,
    0x9969,
    0xA90A,
    0xB92B,
    0x5AF5,
    0x4AD4,
    0x7AB7,
    0x6A96,
    0x1A71,
    0x0A50,
    0x3A33,
    0x2A12,
    0xDBFD,
    0xCBDC,
    0xFBBF,
    0xEB9E,
    0x9B79,
    0x8B58,
    0xBB3B,
    0xAB1A,
    0x6CA6,
    0x7C87,
    0x4CE4,
    0x5CC5,
    0x2C22,
    0x3C03,
    0x0C60,
    0x1C41,
    0xEDAE,
    0xFD8F,
    0xCDEC,
    0xDDCD,
    0xAD2A,
    0xBD0B,
    0x8D68,
    0x9D49,
    0x7E97,
    0x6EB6,
    0x5ED5,
    0x4EF4,
    0x3E13,
    0x2E32,
    0x1E51,
    0x0E70,
    0xFF9F,
    0xEFBE,
    0xDFDD,
    0xCFFC,
    0xBF1B,
    0xAF3A,
    0x9F59,
    0x8F78,
    0x9188,
    0x81A9,
    0xB1CA,
    0xA1EB,
    0xD10C,
    0xC12D,
    0xF14E,
    0xE16F,
    0x1080,
    0x00A1,
    0x30C2,
    0x20E3,
    0x5004,
    0x4025,
    0x7046,
    0x6067,
    0x83B9,
    0x9398,
    0xA3FB,
    0xB3DA,
    0xC33D,
    0xD31C,
    0xE37F,
    0xF35E,
    0x02B1,
    0x1290,
    0x22F3,
    0x32D2,
    0x4235,
    0x5214,
    0x6277,
    0x7256,
    0xB5EA,
    0xA5CB,
    0x95A8,
    0x8589,
    0xF56E,
    0xE54F,
    0xD52C,
    0xC50D,
    0x34E2,
    0x24C3,
    0x14A0,
    0x0481,
    0x7466,
    0x6447,
    0x5424,
    0x4405,
    0xA7DB,
    0xB7FA,
    0x8799,
    0x97B8,
    0xE75F,
    0xF77E,
    0xC71D,
    0xD73C,
    0x26D3,
    0x36F2,
    0x0691,
    0x16B0,
    0x6657,
    0x7676,
    0x4615,
    0x5634,
    0xD94C,
    0xC96D,
    0xF90E,
    0xE92F,
    0x99C8,
    0x89E9,
    0xB98A,
    0xA9AB,
    0x5844,
    0x4865,
    0x7806,
    0x6827,
    0x18C0,
    0x08E1,
    0x3882,
    0x28A3,
    0xCB7D,
    0xDB5C,
    0xEB3F,
    0xFB1E,
    0x8BF9,
    0x9BD8,
    0xABBB,
    0xBB9A,
    0x4A75,
    0x5A54,
    0x6A37,
    0x7A16,
    0x0AF1,
    0x1AD0,
    0x2AB3,
    0x3A92,
    0xFD2E,
    0xED0F,
    0xDD6C,
    0xCD4D,
    0xBDAA,
    0xAD8B,
    0x9DE8,
    0x8DC9,
    0x7C26,
    0x6C07,
    0x5C64,
    0x4C45,
    0x3CA2,
    0x2C83,
    0x1CE0,
    0x0CC1,
    0xEF1F,
    0xFF3E,
    0xCF5D,
    0xDF7C,
    0xAF9B,
    0xBFBA,
    0x8FD9,
    0x9FF8,
    0x6E17,
    0x7E36,
    0x4E55,
    0x5E74,
    0x2E93,
    0x3EB2,
    0x0ED1,
    0x1EF0,
]
